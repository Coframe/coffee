#!/bin/bash

react_IMAGE_NAME="coffee_react"
IMAGE_NAME="coffee"
CONTAINER_NAME="coffee-maker"

build_image() {
    docker build -t ${IMAGE_NAME} ./coffee/maker
    echo "Docker image ${IMAGE_NAME} built successfully."
}

attach_bash() {
    docker exec -it ${CONTAINER_NAME} /bin/bash
    echo "Attached bash session to container ${CONTAINER_NAME}."
}

build_react_image() {
    docker build -t ${react_IMAGE_NAME} ./coffee/react
    echo "Docker react image ${react_IMAGE_NAME} built successfully."
}

run_react() {
    FOLDER=$1
    docker run -it \
        --env-file ./coffee/variables.env \
        -v "$(pwd)/coffee/react:/app" \
        -v "$(pwd)/${FOLDER}:/frontend_dir" \
        ${react_IMAGE_NAME}
}

start_container() {
    FRONTEND_DIR=$1
    docker stop ${CONTAINER_NAME} 2>/dev/null || true
    docker rm ${CONTAINER_NAME} 2>/dev/null || true

    docker run -it \
        --env-file ./coffee/variables.env \
        --name ${CONTAINER_NAME} \
        -v "$(pwd)/coffee/maker:/app" \
        -v "$(pwd)/${FRONTEND_DIR}:/frontend_dir" \
        -p 8000:8000 \
        ${IMAGE_NAME}

    echo "Container ${CONTAINER_NAME} started with frontend directory: ${FRONTEND_DIR}"
}

case "$1" in
    build)
        build_image
        ;;
    bash)
        attach_bash
        ;;
    react)
        case "$2" in
            build)
                build_react_image
                ;;
            *)
                if [ -z "$2" ]; then
                    echo "Error: No folder specified for react command."
                    echo "Usage: $0 react <folder>"
                    exit 1
                fi
                run_react $2
                ;;
        esac
        ;;

    *)
        if [ -z "$1" ]; then
            echo "Error: No command or frontend directory specified."
            echo "Usage: $0 <frontend_directory>"
            echo "       $0 build"
            echo "       $0 bash"
            echo "       $0 watch <folder>"
            exit 1
        fi
        start_container $1
        ;;
esac
